name: Codex PR Review

on:
  workflow_call:
    inputs:
      model:
        description: Optional model override for Codex.
        required: false
        type: string
        default: codex-mini-latest
      effort:
        description: Optional reasoning effort override (low, medium, high).
        required: false
        type: string
        default: medium
      sandbox:
        description: Codex sandbox mode.
        required: false
        type: string
        default: read-only
      working_directory:
        description: Directory to review from.
        required: false
        type: string
        default: .
      codex_args:
        description: Extra args passed to codex exec.
        required: false
        type: string
        default: ""
      additional_instructions:
        description: Extra instructions appended to the default review prompt.
        required: false
        type: string
        default: ""
    secrets:
      OPENAI_API_KEY:
        required: true

concurrency:
  group: codex-pr-review-${{ github.repository }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  codex:
    name: Run Codex
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      final_message: ${{ steps.run_codex.outputs['final-message'] }}
    steps:
      - name: Check out PR merge commit
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Pre-fetch base and head refs
        run: |
          git fetch --no-tags origin \
            "${{ github.event.pull_request.base.ref }}" \
            "+refs/pull/${{ github.event.pull_request.number }}/head"

      - name: Run Codex review
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          github-token: ${{ github.token }}
          model: ${{ inputs.model }}
          effort: ${{ inputs.effort }}
          sandbox: ${{ inputs.sandbox }}
          working-directory: ${{ inputs.working_directory }}
          codex-args: ${{ inputs.codex_args }}
          allow-bots: "true"
          prompt: |
            This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}.
            Review ONLY the changes introduced by this PR.

            Commit range to inspect:
            git log --oneline ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }}

            Pull request title and body:
            ----
            ${{ github.event.pull_request.title }}
            ${{ github.event.pull_request.body }}

            You are an expert senior software engineer reviewing a GitHub Pull Request.

            Goal: Provide a concise, high-signal review focused on correctness, security, reliability, and maintainability.

            Output format (strict):
            1) Summary (2-4 bullets): what changed + overall risk.
            2) Findings grouped by severity in this exact order:
               - P0 Blocker
               - P1 High
               - P2 Medium
               - P3 Nit
               - Questions (if any)
            For each finding:
            - Title (short)
            - File:line (or best-effort file reference)
            - Why it matters (1-2 sentences, concrete impact)
            - Suggested fix (actionable; include code snippet only if it clarifies)

            Severity rubric:
            P0 Blocker: security vulnerability, secret exposure, authz/authn flaws, data loss/corruption risk, crashes, broken tests/build, severe race/concurrency bugs, backwards-incompatible change without mitigation.
            P1 High: likely bug or reliability/perf regression, missing/incorrect error handling, incorrect edge cases, flaky behavior, misused API/library, migration/rollback risk, missing critical observability.
            P2 Medium: maintainability improvements, tests that should be added, refactors that reduce complexity, non-critical perf improvements, documentation gaps.
            P3 Nit: style, naming preference, minor readability.

            Rules:
            - Prefer fewer, higher-impact comments over many small ones.
            - Do NOT request style-only changes at P0/P1.
            - If unsure due to missing context, put it in Questions rather than guessing.
            - Highlight any changes that affect security, privacy, data handling, and backwards compatibility.
            - Check for test coverage: if behavior changed, suggest specific tests.
            - If there are no items for a severity bucket, omit that bucket.

            Additional instructions from caller:
            ${{ inputs.additional_instructions }}

  post_feedback:
    name: Post PR Feedback
    if: ${{ needs.codex.outputs.final_message != '' }}
    runs-on: ubuntu-latest
    needs: codex
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Upsert PR comment
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs.final_message }}
        with:
          github-token: ${{ github.token }}
          script: |
            const marker = "<!-- codex-pr-review -->";
            const raw = process.env.CODEX_FINAL_MESSAGE || "";
            const body = `${marker}\n${raw}`.trim();

            if (!context.payload.pull_request) {
              core.info("No pull request context; skipping feedback comment.");
              return;
            }

            if (!raw.trim()) {
              core.info("No Codex output; skipping feedback comment.");
              return;
            }

            const issue_number = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100
            });

            const existing = comments.find(
              (comment) => comment.user?.type === "Bot" && comment.body?.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
              core.info(`Updated existing Codex comment ${existing.id}.`);
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });
            core.info("Created a new Codex feedback comment.");
